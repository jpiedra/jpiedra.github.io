<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>
    	
  	Scripted S3 Site Deployment with AWS CLI and Powershell, Part 1 &ndash; Jonathan Piedra

    </title>
	
<link type="text/css" rel="stylesheet" href="/css/style.css">
<link type="text/css" rel="stylesheet" href="/css/blogpanel.css">
<link type="text/css" rel="stylesheet" href="/css/projectpanel.css">
<link type="text/css" rel="stylesheet" href="/css/resp.css">
<script defer src="https://use.fontawesome.com/releases/v5.0.6/js/all.js"></script>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Nunito|Roboto|Montserrat">
</head>
<body>
	<ul class="navbar">
	<div class="navbar-left">
		<li class="navbar_brand">
			<a href="http://jpiedra.github.io">Jonathan Piedra</a>
		</li>
	</div>
	<div class="navbar-right">
		<li>
			<a href="http://jpiedra.github.io/article">Articles</a>
		</li>
		<li>
			<a href="http://jpiedra.github.io/project">Projects</a>
		</li>
		<li>
			<a href="mailto:jpiedra1990@gmail.com">Contact</a>
		</li>
	</div>
</ul>
	<div class="col-main">
		
	<div class="blogpanel blogpanel_single">
		<div class="blogpanel_head">
			<div class="blogpanel_head-date">
				<h1>January 20 2018</h1>
			</div>
			<div class="blogpanel_head-title">
				<h1>Scripted S3 Site Deployment with AWS CLI and Powershell, Part 1</h1>
			</div>
		</div>
		<div class="blogpanel_body">
			<p><p>Amazon Web Services, through their Simple Storage Service (S3), provide an inexpensive and flexible solution for hosting static websites. These would normally be sites that are developed on a local environment (using <!-- raw HTML omitted -->Hugo<!-- raw HTML omitted --> or <!-- raw HTML omitted -->Jekyll<!-- raw HTML omitted -->), then pushed to either a web server or - in this case - a cloud-based storage platform configured to make the generated pages public. This post discusses a scripted approach to building a bucket you want to use to host an S3 website from scratch.</p>
<!-- raw HTML omitted -->
<p>Once you have the AWS CLI configured, with keys set up for an account that has permission to configure S3 resources and policies, we can begin writing a script to build a new S3 bucket host site hosting. The finished project can be found at <!-- raw HTML omitted -->this Github repository.<!-- raw HTML omitted --></p>
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<p>Using the text-editor of our choice, we create a new file, <!-- raw HTML omitted -->New-S3Site.ps1<!-- raw HTML omitted --> and add the following contents. While any editor will do, using <!-- raw HTML omitted -->Powershell Integrated Scripting Environment (ISE)<!-- raw HTML omitted --> gives us the added bonus of running our script while writing it.</p>
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<p>While this gets us our check very quickly, to better shape the behavior of our script, we should capture the result of running this command to a variable that can then be used to determine the next step to take, rather than simply print it out on the screen. If you run this command after providing a non-existant bucket name, you&rsquo;ll see something similar to this:
<!-- raw HTML omitted -->
<!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
Now let&rsquo;s capture the contents of this error message by doing two things:</p>
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<p>The <!-- raw HTML omitted -->$result<!-- raw HTML omitted --> variable will now contain an ErrorRecord object if ls fails. (Actually, this turns out to be an <!-- raw HTML omitted -->array<!-- raw HTML omitted --> with one object inside of it, of type ErrorRecord) We know that, if the result of this ls command is an ErrorRecord, that the bucket does not exist. This is useful information that can be leveraged to perform the check we need before proceeding with the creation process, because if we <!-- raw HTML omitted -->don&rsquo;t<!-- raw HTML omitted --> get an error record, then <!-- raw HTML omitted -->$result<!-- raw HTML omitted --> will be null (as nothing came from standard error), and we can check if the bucket exists by checking whether or not <!-- raw HTML omitted -->$result<!-- raw HTML omitted --> is null. If null, the ls succeeded, and thus we should stop the script because there&rsquo;s a bucket there we don&rsquo;t want to tamper with!</p>
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<p>The next AWS CLI command creates our bucket. The constructed <!-- raw HTML omitted -->bucketName<!-- raw HTML omitted --> variable is used here. The command is <!-- raw HTML omitted -->aws s3 mb<!-- raw HTML omitted --> and here, mb is short form for &ldquo;make bucket.&rdquo;</p>
<p>The output of this command is also written to standard error, so we make use of redirection to standard out and place those contents in a variable, which we check later for a specific pattern. If the mb operation succeeds, the contents of the variable will contain &ldquo;make_bucket&rdquo; in it. Here&rsquo;s how we check for that:</p>
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<p>To configure a policy that makes all the files in our bucket publically readable, we apply the action <!-- raw HTML omitted -->GetObject<!-- raw HTML omitted --> for any principal <!-- raw HTML omitted -->denoted by &ldquo;*&quot;<!-- raw HTML omitted --> on all resources under our bucket, which would end up being the Amazon Resource Name (ARN) <!-- raw HTML omitted -->arn:aws:s3:::acme.org/*<!-- raw HTML omitted --> for a hypothetical bucket named acme.org. We use the <!-- raw HTML omitted -->Amazon Policy Generator<!-- raw HTML omitted --> to generate such a policy for us.</p>
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<p>We paste the resulting policy into a file called <!-- raw HTML omitted -->static-site-policy.json<!-- raw HTML omitted -->, in the same directory as our script, that our script will use. The file <!-- raw HTML omitted -->static-site-policy.json<!-- raw HTML omitted --> will become our template, and all we need to do to have it work for our new bucket, is replace the constant BUCKET_NAME with the value of the bucket name we passed in as a parameter. At this point, we would have the following as our complete script:</p>
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<p>At this point, our complete script can create a bucket if it doesn&rsquo;t exist, using a name we provide, and sets a policy for the bucket (which is really just generated by Powershell&rsquo;s Get-Content and Set-Content commandlets, to replace the BUCKET_NAME value) using the command <!-- raw HTML omitted -->aws s3api put-bucket-policy<!-- raw HTML omitted --> which applies the policy in the actual policy file, <!-- raw HTML omitted -->policy.json.<!-- raw HTML omitted --></p>
<p>In the next post for this series, the final piece in our puzzle will be discussed - the <!-- raw HTML omitted -->Upload-S3Site<!-- raw HTML omitted --> script, which will upload all of our website&rsquo;s files to the bucket. The <!-- raw HTML omitted -->Path<!-- raw HTML omitted --> parameter we defined here will play an important role in this second script.</p>
<p>Additional Resources</p>
<!-- raw HTML omitted --></p>
			<a class="blogpanel_body-more" href="http://jpiedra.github.io">Return home</a>
		</div>
		
		<div class="blogpanel_foot">
			<div class="blogpanel_foot">
				<div class="blogpanel_foot-tag-name">
					<p>Tags:</p>
				</div>
				<div class="blogpanel_foot-tag-list">
					<ul>
						
							<li>
								<a href="/tags/aws">aws</a>
							</li>
						
							<li>
								<a href="/tags/powershell">powershell</a>
							</li>
						
							<li>
								<a href="/tags/scripting">scripting</a>
							</li>
						
							<li>
								<a href="/tags/s3">s3</a>
							</li>
						
							<li>
								<a href="/tags/part-1">part 1</a>
							</li>
						
					</ul>
				</div>
			</div>	
		</div>
		
	</div>
	<div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "jpiedra" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

		<div class="col-main_pages" >
			
			
		</div>
	</div>
	<div class="col-side">
		
			<div class="blogpanel">
	<div class="blogpanel_head">
		<div class="blogpanel_head-title">
			<h1>Tags</h1>
		</div>
	</div>
	<div class="blogpanel_body">
		<div class="blogpanel_foot-tag-list">
			<ul>
				
				
				
				
					<li>
						<a href="/tags/api">api</a>
					</li>
				
					<li>
						<a href="/tags/aws">aws</a>
					</li>
				
					<li>
						<a href="/tags/bash">bash</a>
					</li>
				
					<li>
						<a href="/tags/constructor">constructor</a>
					</li>
				
					<li>
						<a href="/tags/css">css</a>
					</li>
				
					<li>
						<a href="/tags/design">design</a>
					</li>
				
					<li>
						<a href="/tags/development">development</a>
					</li>
				
					<li>
						<a href="/tags/ec2">ec2</a>
					</li>
				
					<li>
						<a href="/tags/es5">es5</a>
					</li>
				
					<li>
						<a href="/tags/git">git</a>
					</li>
				
					<li>
						<a href="/tags/javascript">javascript</a>
					</li>
				
					<li>
						<a href="/tags/linux">linux</a>
					</li>
				
					<li>
						<a href="/tags/module">module</a>
					</li>
				
					<li>
						<a href="/tags/mysql">mysql</a>
					</li>
				
					<li>
						<a href="/tags/nodejs">nodejs</a>
					</li>
				
					<li>
						<a href="/tags/part-1">part-1</a>
					</li>
				
					<li>
						<a href="/tags/part-2">part-2</a>
					</li>
				
					<li>
						<a href="/tags/php">php</a>
					</li>
				
					<li>
						<a href="/tags/powershell">powershell</a>
					</li>
				
					<li>
						<a href="/tags/python">python</a>
					</li>
				
					<li>
						<a href="/tags/s3">s3</a>
					</li>
				
					<li>
						<a href="/tags/scripting">scripting</a>
					</li>
				
					<li>
						<a href="/tags/squarespace">squarespace</a>
					</li>
				
					<li>
						<a href="/tags/tips">tips</a>
					</li>
				
					<li>
						<a href="/tags/troubleshooting">troubleshooting</a>
					</li>
				
					<li>
						<a href="/tags/virtualbox">virtualbox</a>
					</li>
				
					<li>
						<a href="/tags/virtualization">virtualization</a>
					</li>
				
					<li>
						<a href="/tags/webdev">webdev</a>
					</li>
				
			</ul>
		</div>
	</div>
</div>
			<div class="blogpanel">
	<div class="blogpanel_head">
		<div class="blogpanel_head-title">
			<h1>Recent Posts</h1>
		</div>
	</div>
	<div class="blogpanel_body">
		<div class="blogpanel_foot-post-list">
			<ol>
				
				
					<li>
						<a href="http://jpiedra.github.io/article/">
							Articles - Posted Jul 26 2018
						</a>
					</li>
				
					<li>
						<a href="http://jpiedra.github.io/tags/javascript/">
							javascript - Posted Jul 26 2018
						</a>
					</li>
				
					<li>
						<a href="http://jpiedra.github.io/">
							Jonathan Piedra - Posted Jul 26 2018
						</a>
					</li>
				
					<li>
						<a href="http://jpiedra.github.io/tags/mysql/">
							mysql - Posted Jul 26 2018
						</a>
					</li>
				
					<li>
						<a href="http://jpiedra.github.io/article/mysql-connector-node/">
							Node.js Connector to a MySQL Database - Posted Jul 26 2018
						</a>
					</li>
				
					<li>
						<a href="http://jpiedra.github.io/tags/nodejs/">
							nodejs - Posted Jul 26 2018
						</a>
					</li>
				
					<li>
						<a href="http://jpiedra.github.io/tags/">
							Tags - Posted Jul 26 2018
						</a>
					</li>
				
					<li>
						<a href="http://jpiedra.github.io/tags/aws/">
							aws - Posted Jul 8 2018
						</a>
					</li>
				
					<li>
						<a href="http://jpiedra.github.io/tags/ec2/">
							ec2 - Posted Jul 8 2018
						</a>
					</li>
				
					<li>
						<a href="http://jpiedra.github.io/article/never-update-security-group/">
							Never Update an AWS Security Group Again - Posted Jul 8 2018
						</a>
					</li>
				
			</ol>
		</div>
	</div>
</div>
		
	</div>
</body>
</html>